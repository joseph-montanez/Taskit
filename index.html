<!doctype html>
<html manifest="todo.manifest"> 
<head>
    <script type="text/javascript" src="http://gorilla3d.com/json2.js"></script>
    <script type="text/javascript">
        // Classes
        function Gorilla3D() {}
        Gorilla3D.prototype.Storage = function () {
            this.storageDomain = location.hostname;
            if (this.storageDomain == "localhost") {
                this.storageDomain += ".localdomain";
            }
            this.store = false;
            if(typeof localStorage !== 'undefined') {
                this.store = localStorage;
                this.getItem = function (key, func) {
                    func(this.store.getItem(key));
                }
                this.setItem = function (key, value) {
                    this.store.setItem(key, value);
                    return this;
                }
            } else if(typeof globalStorage !== 'undefined') {
                this.store = globalStorage[this.storageDomain];
                this.setItem = function (key, value) {
                    this.store[key] = value;
                    return this;
                };
                this.getItem = function (key) {
                    func(this.store[key]);
                };
            } else if(typeof window.openDatabase !== 'undefined') {
                this.store = openDatabase(this.storageDomain, '1.0', "G3D Storage Alternative", 200000);
                if(!this.store) {
                    console.log('unable to open database');
                }
                // Create the Database
                this.store.transaction(function (tx) {
                    tx.executeSql(
                        'SELECT COUNT(*) FROM storage', [], function(result) {}, 
                        function(tx, error) {
                            // Create Database
                            var sql = 'CREATE TABLE storage ('
                                  + 'storage_key VARCHAR(255) UNIQUE,'
                                  + 'storage_value TEXT'
                                + ')';
                            tx.executeSql(sql, [], function(result) {});
                        }
                    );
                });    
                this.setItem = function (key, value) {
                    var exists = false;
                    
                    this.store.transaction(function (tx) {
                        // See if the key exists
                        var sql = 'SELECT storage_key FROM storage WHERE storage_key = ?';
                        tx.executeSql(sql, [key], function (tx, result) {
                            if(result.rows.length > 0) {
                                exists = true;
                            }
                            // Toggle between an update / insert
                            if(exists !== true) {
                                sql = 'INSERT INTO storage (storage_key, storage_value) VALUES(?, ?)';
                                tx.executeSql(sql, [key, value], function (tx, result) {}, function(tx, error) {
                                    alert('INSERT ERROR: ' + error.message);
                                });
                            } else {
                                sql = 'UPDATE storage SET storage_value = ? WHERE storage_key = ?';
                                tx.executeSql(sql, [value, key], function (tx, result) {}, function(tx, error) {
                                    alert('UPDATE ERROR: ' + error.message);
                                });
                            }
                        });
                    });
                    return this;
                };
                this.getItem = function (key, func) {
                    var $Storage = this;
                    storage_value = false;
                    var sql = 'SELECT storage_value FROM storage WHERE storage_key = ?';
                    this.store.transaction(function (tx) {
                        tx.executeSql(sql, [key], function (tx, result) {
                            if(result.rows.length > 0) {
                                func(result.rows.item(0).storage_value);tasks.toString()
                            }
                        }, function (tx, error) {
                            alert('GET ERROR: ' + error.message);
                        });
                    });
                };
            } else {
                // TODO: tell them they can't use this webapp
            }
        }
        
        Gorilla3D.prototype.TaskTable = function () {
            this.rows = [];
            this.toString =  function () {
                return JSON.stringify(this.rows, function (key, value) {
                    return value;
                });
            };
            this.fromString = function (rows) {
                this.rows = eval('(' + rows + ')');
            };
            this.each = function (func) {
                var rlen = this.rows.length;
                for (var i=0; i < rlen; i++) {
                    if(typeof this.rows[i] === 'object') {
                        func(this.rows[i], i);
                    }
                }
                return this;
            };
            this.get = function (task_id) {
                var $TaskTable = this;
                var task = false;
                this.each(function (row, i) {
                    if(row.id === task_id) {
                        task = row;
                        return;
                    }
                });
                return task;
            };
            this.remove = function (task_id) {
                var $TaskTable = this;
                var task = false;
                this.each(function (row, i) {
                    if(row.id === task_id) {
                        task = row;
                        delete $TaskTable.rows[i];
                        return;
                    }
                });
                return task;
            };
        }
        
        // Namespaces
        var g3d = new Gorilla3D();
        // Globals 
        var taskStorage = "[]";
        var tasks = new g3d.TaskTable();
        var storage = new g3d.Storage();
        
        function loaded() {
            storage.getItem('taskStorage', function (value) {
                if (value) {
                    taskStorage = value
                } 
                tasks.fromString(taskStorage);
                loadList();
            });
        }
        
        function loadList() {
            var taskList = document.getElementById("tasklist");
            taskList.innerHTML = '';
            tasks.each(function (task, i) {
                var input = document.createElement('input');
                input.setAttribute('type', 'checkbox');
                input.setAttribute('id', 'task_' + task.id);
                input.setAttribute('task_id', task.id);
                taskList.appendChild(input);
                
                var label = document.createElement('label');
                label.setAttribute('type', 'checkbox');
                label.setAttribute('id', 'task_' + task.id);
                taskList.appendChild(label);
                
                var text = document.createTextNode(task.name);
                if(task.status === 'completed') {
                    var del = document.createElement('del');
                    del.appendChild(text);  
                    taskList.appendChild(del);                  
                } else {
                    taskList.appendChild(text);
                }
                
                var br = document.createElement('br');
                taskList.appendChild(br);
            });
            saveToDisk();
        }
        
        function saveToDisk() {
            storage.setItem('taskStorage', tasks.toString());
        }
        
        function addTask(form) {
            var task_date = new Date();
            var task_id = task_date + "";
            task_id = task_id.match(/\d+/g).join('') + Math.floor(Math.random() * 1000);
            tasks.rows.push({
                'id': task_id,
                'name': form.task_name.value,
                //'date': task_date,
                'status': 'uncompleted'
            });
            loadList();
        }
        
        function getCheckedTasks(form) {
            var elems = form.elements;
            var elen = elems.length;
            var checked = []
            for(var i = 0; i < elen; i++) {
                if(elems[i].getAttribute('type') === 'checkbox' && elems[i].checked === true) {
                    checked.push(elems[i]);
                }
            }
            return checked;
        }
        
        function completeTasks(form) {
            var elems = getCheckedTasks(form);
            var elen = elems.length;
            for(var i = 0; i < elen; i++) {
                var ele = elems[i];
                var task = tasks.get(ele.getAttribute('task_id'));
                task.status = 'completed';
            }
            loadList();
        }
        
        function deleteTasks(form) {
            var elems = getCheckedTasks(form);
            var elen = elems.length;
            for(var i = 0; i < elen; i++) {
                var ele = elems[i];
                var task = tasks.remove(ele.getAttribute('task_id'));
            }
            loadList();
        }
        
        function uncompleteTasks(form) {
            var elems = getCheckedTasks(form);
            var elen = elems.length;
            for(var i = 0; i < elen; i++) {
                var ele = elems[i];
                var task = tasks.get(ele.getAttribute('task_id'));
                task.status = 'uncompleted';
            }
            loadList();
        }
    </script>
</head>
<body onload="loaded()">
    <form action="" onsubmit="return false">
        <div id="tasklist"></div>
        <input type="button" value="Done" onclick="completeTasks(this.form);"/> 
        <input type="button" value="Not Done" onclick="uncompleteTasks(this.form);"/> 
        <input type="button" value="Delete" onclick="deleteTasks(this.form);"/> 
    </form>
    <form action="" onsubmit="return false">
        <input type="text" id="task_name" size="35" /> 
        <input type="button" value="Add" onclick="addTask(this.form);"/> 
    </form>
    <button onclick="storage.setItem('taskStorage', '[]'); loaded();">Clear Storage</button>
</body>
</html>
